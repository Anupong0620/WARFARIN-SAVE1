<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warfarin Save</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f4f7f6;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --primary:#0056b3;
      --success:#28a745;
      --danger:#dc3545;
      --border:#e5e7eb;
      --shadow:0 8px 22px rgba(0,0,0,0.08);
      --radius:14px;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0; background:var(--bg); color:var(--text);
      font-family:'Sarabun',system-ui,Segoe UI,Roboto,Arial,"Noto Sans Thai",sans-serif
    }

    /* ‡πÅ‡∏ñ‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ö‡∏ô‡∏™‡∏∏‡∏î (sticky) */
    .topbar{
      position: sticky; top: 0; z-index: 50;
      background: linear-gradient(180deg, #f4f7f6 90%, rgba(244,247,246,0));
      padding: 16px 12px 8px; display:flex; justify-content:center;
    }
    .link-btn{
      display:inline-flex; align-items:center; gap:10px;
      background:var(--success); color:#fff; font-weight:700;
      padding:10px 18px; border-radius:10px; text-decoration:none;
      box-shadow:0 6px 14px rgba(40,167,69,0.25);
      transition: transform .06s ease, filter .2s ease;
    }
    .link-btn:hover{ filter:brightness(0.95); }
    .link-btn:active{ transform:translateY(1px); }

    .wrap{max-width: 860px; margin: 0 auto; padding: 0 14px 28px;}
    .container{
      width:100%; background:var(--card); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 26px; margin-top: 6px;
    }

    h1{
      color:var(--primary); text-align:center; font-size: clamp(22px,2.6vw,32px);
      margin: 8px 0 18px; display:flex; align-items:center; justify-content:center; gap:10px;
    }

    fieldset{border:1px solid var(--border); border-radius:10px; padding:16px; margin: 18px 0;}
    legend{font-weight:700; color:#374151; padding:0 8px}
    label{display:block; margin-bottom:8px; font-weight:600; color:#374151}
    .help{color:var(--muted); font-size:.95rem}

    input[type="date"], input[type="number"], input[type="text"], select, textarea{
      width:100%; padding:11px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:1rem;
      outline:none; transition: box-shadow .15s ease, border-color .15s ease; background:#fff;
    }
    textarea{resize:vertical}
    input:focus, select:focus, textarea:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,0.15)}

    .date-row{display:grid; grid-template-columns: 1fr; gap:14px}
    @media (min-width: 680px){ .date-row{ grid-template-columns: 1fr 1fr; } }

    .radio-group{display:flex; flex-wrap:wrap; gap:14px}
    .radio-group label{display:inline-flex; align-items:center; gap:8px; font-weight:500; margin:0}

    .inline-controls{display:flex; flex-wrap:wrap; gap:22px; align-items:end}
    .inline-controls .control-item{display:flex; align-items:center; gap:8px}
    .inline-controls input[type="number"]{width:90px}

    /* ====== ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ã‡πâ‡∏≠‡∏ô" ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ====== */
    .dose-line{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: nowrap;          /* ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ö‡∏ô‡∏à‡∏≠‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    }
    .dose-line span{ white-space:nowrap; } /* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏Å‡∏•‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ */
    .dose-line input[type="number"]{
      width:90px; flex:0 0 90px;  /* ‡∏ä‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡πÑ‡∏°‡πà‡∏î‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô */
    }
    .dose-line select{
      flex:0 0 auto;
      width:auto; max-width:100%; min-width:210px;  /* ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ ‡πÑ‡∏°‡πà‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏ô‡∏ï‡∏Å‡∏•‡πà‡∏≤‡∏á */
    }
    /* ‡∏à‡∏≠‡πÅ‡∏Ñ‡∏ö‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡∏≠‡∏°‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
    @media (max-width: 640px){
      .dose-line{ flex-wrap:wrap; }
      .dose-line select{ min-width:180px; }
    }
    /* =============================================== */

    #incorrect-details{display:none}

    #recommendation{
      margin-top:10px; padding:14px; background:#e9f7ef; border-left:6px solid var(--success);
      border-radius:10px; min-height:50px; color:#065f46; font-weight:600
    }

    .dose-results{display:grid; grid-template-columns:1fr; gap:14px}
    @media (min-width: 680px){ .dose-results{ grid-template-columns:1fr 1fr; } }
    .result-card{padding:12px 14px; border:1px dashed var(--border); border-radius:10px; background:#fafafa}
    .result-card strong{color:var(--primary); font-size:1.1rem}
    #doseChangePercent.increase{color:#15803d}
    #doseChangePercent.decrease{color:#b91c1c}

    .button-group{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px; border:none; cursor:pointer;
      padding:12px 12px; border-radius:10px; font-weight:700; font-size:1.05rem; color:#fff;
      transition: filter .15s ease, transform .06s ease;
    }
    .btn:active{transform:translateY(1px)}
    #getResultButton{background:#007bff}
    #getResultButton:hover{filter:brightness(.95)}
    #resetButton{background:var(--danger)}
    #resetButton:hover{filter:brightness(.95)}

    #summarySection{display:none; margin-top: 16px}
    #summaryHeader{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
    #copyButton{
      padding:8px 14px; font-size:.95rem; background:#6c757d; color:white; border:none; border-radius:10px; cursor:pointer
    }
    #copyButton:hover{filter:brightness(.95)}
  </style>
</head>
<body>
  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ö‡∏ô‡∏™‡∏∏‡∏î -->
  <div class="topbar">
    <a class="link-btn" href="http://thaiacc.org/warfarin/program2/#/" target="_blank" rel="noopener">
      üåê ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° Warfarin Online
    </a>
  </div>

  <div class="wrap">
    <div class="container">
      <h1>Warfarin Save üìù</h1>

      <form id="warfarinForm" onsubmit="return false;">
        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ -->
        <fieldset>
          <legend>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</legend>
          <div class="date-row">
            <div class="form-group">
              <label for="visitDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•:</label>
              <input type="date" id="visitDate" name="visitDate" />
            </div>
            <div class="form-group">
              <label for="nextAppointment">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ:</label>
              <input type="date" id="nextAppointment" name="nextAppointment" />
            </div>
          </div>
        </fieldset>

        <!-- INR & ‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤ -->
        <fieldset>
          <legend>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• INR ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤</legend>

          <div class="form-group">
            <label>‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</label>
            <div class="radio-group">
              <label><input type="radio" name="medicationAdherence" value="‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" checked>‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</label>
              <label><input type="radio" name="medicationAdherence" value="‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á">‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</label>
            </div>
            <div id="incorrect-details" class="form-group">
              <label for="incorrectReason">‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</label>
              <textarea id="incorrectReason" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏∑‡∏°‡∏Å‡∏¥‡∏ô 2 ‡∏ß‡∏±‡∏ô / ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÄ‡∏≠‡∏á ‡∏Ø‡∏•‡∏Ø"></textarea>
            </div>
          </div>

          <div class="form-group">
            <label>INR ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</label>
            <div class="radio-group">
              <label><input type="radio" name="targetINR" value="2-3" checked>2‚Äì3</label>
              <label><input type="radio" name="targetINR" value="2.5-3.5">2.5‚Äì3.5</label>
              <label><input type="radio" name="targetINR" value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ:
                <input type="text" id="otherINR" style="width:110px" disabled placeholder="‡πÄ‡∏ä‡πà‡∏ô 2.0‚Äì2.5">
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="previousDose">‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (mg/wk):</label>
            <input type="number" id="previousDose" step="0.1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå" />
          </div>

          <div class="form-group">
            <label for="currentINR">INR ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</label>
            <input type="number" id="currentINR" step="0.1" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤ INR ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç" />
          </div>
        </fieldset>

        <!-- ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
        <fieldset>
          <legend>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡∏ú‡∏• INR</legend>
          <div id="recommendation"><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å INR ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p></div>
          <p class="help">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏î‡∏∏‡∏•‡∏¢‡∏û‡∏¥‡∏ô‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
        </fieldset>

        <!-- ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
        <fieldset>
          <legend>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</legend>
          <div class="inline-controls">
            <div class="control-item">
              <label><input type="checkbox" id="stopMedCheckbox">‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤</label>
              <input type="number" id="stopMedDays" placeholder="‡∏ß‡∏±‡∏ô" disabled>
              <span class="help">‡∏ß‡∏±‡∏ô</span>
            </div>
            <div class="control-item">
              <label><input type="checkbox" id="vitKCheckbox">‡πÉ‡∏´‡πâ Vitamin K</label>
              <input type="number" id="vitKMg" step="0.1" placeholder="mg" disabled>
              <span class="help">mg</span>
            </div>
          </div>
        </fieldset>

        <!-- ‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
        <fieldset>
          <legend>‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</legend>

          <div class="form-group">
            <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤ (Strength):</label>
            <div class="radio-group">
              <label><input type="radio" name="tabletStrength" value="2">2 mg</label>
              <label><input type="radio" name="tabletStrength" value="3" checked>3 mg</label>
              <label><input type="radio" name="tabletStrength" value="5">5 mg</label>
            </div>
          </div>

          <!-- ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÇ‡∏î‡∏™‡∏ó‡∏µ‡πà 1 -->
          <div class="form-group dose-line">
            <span>‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞</span>
            <input type="number" id="dose1_qty" value="1" step="0.5">
            <span>‡πÄ‡∏°‡πá‡∏î ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô</span>
            <select id="dose1_days">
              <option value="7">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</option>
              <option value="3" selected>‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡∏û‡∏∏‡∏ò ‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
              <option value="5">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡∏ñ‡∏∂‡∏á ‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
              <option value="6">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡∏ñ‡∏∂‡∏á ‡πÄ‡∏™‡∏≤‡∏£‡πå</option>
            </select>
          </div>

          <!-- ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÇ‡∏î‡∏™‡∏ó‡∏µ‡πà 2 -->
          <div class="form-group dose-line">
            <span>‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞</span>
            <input type="number" id="dose2_qty" value="0.5" step="0.5">
            <span>‡πÄ‡∏°‡πá‡∏î ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô</span>
            <select id="dose2_days">
              <option value="0">- (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)</option>
              <option value="4" selected>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</option>
              <option value="2">‡πÄ‡∏™‡∏≤‡∏£‡πå - ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
              <option value="1">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</option>
            </select>
          </div>

          <div class="dose-results">
            <div class="result-card">
              <div><strong>‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</strong></div>
              <div id="totalDoseResult">0 mg/wk</div>
            </div>
            <div class="result-card">
              <div><strong>‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤</strong></div>
              <div id="doseChangePercent">- %</div>
            </div>
          </div>
        </fieldset>

        <!-- ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
        <fieldset>
          <legend>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</legend>
          <div class="result-card" style="margin-bottom:10px">
            <div><strong>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ô‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</strong></div>
            <div id="appointmentDuration">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î</div>
          </div>
          <div class="result-card">
            <div><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ô‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</strong></div>
            <div id="totalTabletsNeeded">- ‡πÄ‡∏°‡πá‡∏î</div>
          </div>
        </fieldset>

        <!-- ‡∏õ‡∏∏‡πà‡∏° -->
        <div class="button-group">
          <button type="button" class="btn" id="getResultButton">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏£‡∏∏‡∏õ</button>
          <button type="button" class="btn" id="resetButton">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <!-- ‡∏™‡∏£‡∏∏‡∏õ -->
        <div id="summarySection">
          <div id="summaryHeader">
            <label for="summaryOutput">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ:</label>
            <button type="button" id="copyButton">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
          </div>
          <textarea id="summaryOutput" rows="14" readonly></textarea>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---------- ‡πÄ‡∏Å‡πá‡∏ö Elements ----------
    const warfarinForm = document.getElementById('warfarinForm');
    const visitDateInput = document.getElementById('visitDate');
    const nextAppointmentInput = document.getElementById('nextAppointment');
    const medicationRadios = document.querySelectorAll('input[name="medicationAdherence"]');
    const incorrectDetailsDiv = document.getElementById('incorrect-details');
    const incorrectReasonTextarea = document.getElementById('incorrectReason');

    const currentINRInput = document.getElementById('currentINR');
    const targetINRRadios = document.querySelectorAll('input[name="targetINR"]');
    const recommendationDiv = document.getElementById('recommendation');
    const otherINRRadio = document.querySelector('input[value="other"]');
    const otherINRInput = document.getElementById('otherINR');

    const previousDoseInput = document.getElementById('previousDose');

    const stopMedCheckbox = document.getElementById('stopMedCheckbox');
    const stopMedDays = document.getElementById('stopMedDays');
    const vitKCheckbox = document.getElementById('vitKCheckbox');
    const vitKMg = document.getElementById('vitKMg');

    const strengthRadios = document.querySelectorAll('input[name="tabletStrength"]');
    const dose1QtyInput = document.getElementById('dose1_qty');
    const dose1DaysSelect = document.getElementById('dose1_days');
    const dose2QtyInput = document.getElementById('dose2_qty');
    const dose2DaysSelect = document.getElementById('dose2_days');

    const totalDoseResultDiv = document.getElementById('totalDoseResult');
    const doseChangePercentDiv = document.getElementById('doseChangePercent');
    const appointmentDurationDiv = document.getElementById('appointmentDuration');
    const totalTabletsNeededDiv = document.getElementById('totalTabletsNeeded');

    const getResultButton = document.getElementById('getResultButton');
    const resetButton = document.getElementById('resetButton');
    const summarySection = document.getElementById('summarySection');
    const summaryOutput = document.getElementById('summaryOutput');
    const copyButton = document.getElementById('copyButton');

    // ---------- Helper ----------
    function formatNumber(num){ return (num % 1 === 0) ? String(num) : num.toFixed(1); }

    // ---------- ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏° INR ----------
    function updateRecommendation(){
      const inrValue = parseFloat(currentINRInput.value);
      const targetRange = document.querySelector('input[name="targetINR"]:checked').value;
      let text = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å INR ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';

      if (isNaN(inrValue)){
        recommendationDiv.innerHTML = `<p>${text}</p>`;
        return;
      }

      if (targetRange === '2-3'){
        if (inrValue < 1.5) text = '<strong>INR &lt; 1.5:</strong> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤ warfarin ‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå 10‚Äì20%';
        else if (inrValue <= 1.9) text = '<strong>INR 1.5‚Äì1.9:</strong> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤ 5‚Äì10%';
        else if (inrValue <= 3) text = '<strong>INR 2‚Äì3:</strong> ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤';
        else if (inrValue <= 3.9) text = '<strong>INR 3.1‚Äì3.9:</strong> ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤ 5‚Äì10%';
        else if (inrValue <= 4.9) text = '<strong>INR 4.0‚Äì4.9:</strong> ‡∏´‡∏¢‡∏∏‡∏î 1 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏•‡∏î 10%';
        else if (inrValue <= 8.9) text = '<strong>INR 5‚Äì8.9:</strong> ‡∏´‡∏¢‡∏∏‡∏î 1‚Äì2 ‡∏ß‡∏±‡∏ô, ‡∏•‡∏î 20% ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ Vitamin K 1‚Äì2.5 mg';
        else text = '<strong>INR &gt; 8.9:</strong> ‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤, ‡∏•‡∏î 20% ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ Vitamin K 5‚Äì10 mg';
      } else if (targetRange === '2.5-3.5'){
        if (inrValue < 2) text = '<strong>INR &lt; 2:</strong> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤ 10‚Äì20%';
        else if (inrValue <= 2.4) text = '<strong>INR 2‚Äì2.4:</strong> ‡πÄ‡∏û‡∏¥‡πà‡∏° 5‚Äì10%';
        else if (inrValue <= 3.5) text = '<strong>INR 2.5‚Äì3.5:</strong> ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤';
        else if (inrValue <= 4.4) text = '<strong>INR 3.6‚Äì4.4:</strong> ‡∏•‡∏î 5‚Äì10%';
        else if (inrValue <= 6) text = '<strong>INR 4.5‚Äì6:</strong> ‡∏´‡∏¢‡∏∏‡∏î 1 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏•‡∏î 10%';
        else if (inrValue <= 9.4) text = '<strong>INR 6.1‚Äì9.4:</strong> ‡∏´‡∏¢‡∏∏‡∏î 1‚Äì2 ‡∏ß‡∏±‡∏ô, ‡∏•‡∏î 20% ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ Vitamin K 1‚Äì2.5 mg';
        else text = '<strong>INR &gt; 9.4:</strong> ‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤, ‡∏•‡∏î 20% ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ Vitamin K 5‚Äì10 mg';
      } else {
        text = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ';
      }
      recommendationDiv.innerHTML = `<p>${text}</p>`;
    }

    // ---------- ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏î‡∏™ ----------
    function getWeeklyTablets(){
      const q1 = parseFloat(dose1QtyInput.value) || 0;
      const d1 = parseInt(dose1DaysSelect.value,10) || 0;
      const q2 = parseFloat(dose2QtyInput.value) || 0;
      const d2 = parseInt(dose2DaysSelect.value,10) || 0;
      return (q1*d1) + (q2*d2);
    }
    function getWeeklyMg(){
      const strength = parseFloat(document.querySelector('input[name="tabletStrength"]:checked').value) || 0;
      return strength * getWeeklyTablets();
    }
    function calculateDoseChange(){
      const prev = parseFloat(previousDoseInput.value);
      const now = getWeeklyMg();
      doseChangePercentDiv.classList.remove('increase','decrease');

      if (isNaN(prev) || prev <= 0){ doseChangePercentDiv.textContent='- %'; return; }

      const pct = ((now - prev) / prev) * 100;
      if (pct > 0){ doseChangePercentDiv.textContent = `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ${pct.toFixed(2)} %`; doseChangePercentDiv.classList.add('increase'); }
      else if (pct < 0){ doseChangePercentDiv.textContent = `‡∏•‡∏î‡∏•‡∏á ${Math.abs(pct).toFixed(2)} %`; doseChangePercentDiv.classList.add('decrease'); }
      else { doseChangePercentDiv.textContent='‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á 0.00 %'; }
    }
    function updateAllDoseCalculations(){
      const weeklyMg = getWeeklyMg();
      totalDoseResultDiv.textContent = `${formatNumber(weeklyMg)} mg/wk`;
      calculateDoseChange();
      calculateTotalTabletsNeeded();
    }

    // ---------- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡πá‡∏î‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ô‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ----------
    function calculateTotalTabletsNeeded(){
      const visitDate = new Date(visitDateInput.value);
      const nextDate = new Date(nextAppointmentInput.value);

      if (!visitDateInput.value || !nextAppointmentInput.value || nextDate < visitDate){
        appointmentDurationDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        totalTabletsNeededDiv.textContent = '- ‡πÄ‡∏°‡πá‡∏î';
        return;
      }

      // ‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ (+1)
      const diffTime = nextDate.getTime() - visitDate.getTime();
      const diffDays = Math.round(diffTime / (1000*60*60*24)) + 1;

      const weeklyTablets = getWeeklyTablets();
      const weeks = Math.floor(diffDays / 7);
      const remainingDays = diffDays % 7;

      // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏û‡∏ó‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô)
      const avgPerDay = weeklyTablets / 7;
      const tabletsForRemain = Math.round(avgPerDay * remainingDays);

      const totalTabs = Math.round(weeks * weeklyTablets + tabletsForRemain);

      appointmentDurationDiv.textContent = `${weeks} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${remainingDays} ‡∏ß‡∏±‡∏ô`;
      totalTabletsNeededDiv.textContent = `${totalTabs} ‡πÄ‡∏°‡πá‡∏î`;
    }

    // ---------- ‡∏™‡∏£‡∏∏‡∏õ ----------
    function generateSummary(){
      let summary = '========== ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Warfarin ==========\n';
      let adherence = document.querySelector('input[name="medicationAdherence"]:checked').value;
      if (adherence === '‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'){
        const reason = (incorrectReasonTextarea.value || '').trim();
        if (reason) adherence += ` (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason})`;
      }
      summary += `‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤ ${adherence}\n`;

      const targetINRValue = document.querySelector('input[name="targetINR"]:checked').value;
      const currentINRValue = currentINRInput.value || '-';
      summary += `INR ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ : ${targetINRValue}   INR ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ : ${currentINRValue}\n`;

      summary += `‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${recommendationDiv.textContent.trim()}\n\n`;
      summary += '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≤\n';
      summary += `‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á: ${doseChangePercentDiv.textContent}\n`;

      const strengthText = document.querySelector('input[name="tabletStrength"]:checked').value + ' mg';
      summary += `Warfarin ${strengthText}\n`;

      const dose1DaysText = dose1DaysSelect.options[dose1DaysSelect.selectedIndex].text;
      summary += `‡∏Å‡∏¥‡∏ô ${dose1QtyInput.value} ‡πÄ‡∏°‡πá‡∏î ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô ${dose1DaysText}\n`;

      if ((parseFloat(dose2QtyInput.value) || 0) > 0 && dose2DaysSelect.value !== '0'){
        const dose2DaysText = dose2DaysSelect.options[dose2DaysSelect.selectedIndex].text;
        summary += `‡πÅ‡∏•‡∏∞ ‡∏Å‡∏¥‡∏ô ${dose2QtyInput.value} ‡πÄ‡∏°‡πá‡∏î ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô ${dose2DaysText}\n`;
      }

      const weeklyMg = getWeeklyMg();
      summary += `‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤ ${formatNumber(weeklyMg)} mg/wk\n`;
      summary += `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ: ${totalTabletsNeededDiv.textContent}\n`;

      const extra = [];
      if (stopMedCheckbox.checked && stopMedDays.value) extra.push(`‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ ${stopMedDays.value} ‡∏ß‡∏±‡∏ô`);
      if (vitKCheckbox.checked && vitKMg.value) extra.push(`‡πÉ‡∏´‡πâ Vitamin K ${vitKMg.value} mg`);
      if (extra.length) summary += `${extra.join(' + ')}\n`;

      summaryOutput.value = summary;
      summarySection.style.display = 'block';
    }

    // ---------- ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï ----------
    function resetForm(){
      warfarinForm.reset();
      summarySection.style.display = 'none';
      incorrectDetailsDiv.style.display = 'none';
      const today = new Date().toISOString().split('T')[0];
      visitDateInput.value = today;
      updateRecommendation();
      updateAllDoseCalculations();
      otherINRInput.disabled = true;
      stopMedDays.disabled = true;
      vitKMg.disabled = true;
      window.scrollTo(0,0);
    }

    // ---------- Events ----------
    stopMedCheckbox.addEventListener('change', () => {
      stopMedDays.disabled = !stopMedCheckbox.checked; if(!stopMedCheckbox.checked) stopMedDays.value='';
    });
    vitKCheckbox.addEventListener('change', () => {
      vitKMg.disabled = !vitKCheckbox.checked; if(!vitKCheckbox.checked) vitKMg.value='';
    });
    copyButton.addEventListener('click', () => {
      summaryOutput.select();
      navigator.clipboard.writeText(summaryOutput.value)
        .then(()=>{ copyButton.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!'; setTimeout(()=>copyButton.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å',1500); })
        .catch(()=>{ alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); });
    });

    currentINRInput.addEventListener('input', updateRecommendation);
    targetINRRadios.forEach(r => r.addEventListener('change', () => {
      const useOther = otherINRRadio.checked;
      otherINRInput.disabled = !useOther;
      if (!useOther) otherINRInput.value='';
      updateRecommendation();
    }));
    medicationRadios.forEach(r => r.addEventListener('change', (e)=>{
      incorrectDetailsDiv.style.display = (e.target.value === '‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á') ? 'block' : 'none';
    }));
    previousDoseInput.addEventListener('input', calculateDoseChange);

    // ‡πÇ‡∏î‡∏™/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
    const doseInputs = [dose1QtyInput, dose1DaysSelect, dose2QtyInput, dose2DaysSelect];
    strengthRadios.forEach(r => r.addEventListener('change', updateAllDoseCalculations));
    doseInputs.forEach(el => {
      const ev = (el.tagName === 'SELECT') ? 'change' : 'input';
      el.addEventListener(ev, updateAllDoseCalculations);
    });

    visitDateInput.addEventListener('change', calculateTotalTabletsNeeded);
    nextAppointmentInput.addEventListener('change', calculateTotalTabletsNeeded);

    getResultButton.addEventListener('click', generateSummary);
    resetButton.addEventListener('click', resetForm);

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    document.addEventListener('DOMContentLoaded', ()=>{
      const today = new Date().toISOString().split('T')[0];
      visitDateInput.value = today;
      updateRecommendation();
      updateAllDoseCalculations();
    });
  </script>
</body>
</html>
